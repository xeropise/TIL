## 트랜잭션과 로그

- SQL 처리 작업은 주기억 장치에서 이루어지므로 처리 중 장애가 발생할 경우, 처리 결과가 소실되는 등 심각한 문제가 발생할 수 있다.

- 로그 회복은 장애 발생에 대한 안전한 복구를 지원하기 위한 대표적 기법이다.

<br>

---

#### 트랜잭션 처리 과정

<br>

1. 데이터 변경 요청이 데이터베이스 서버로 들어오면 DBMS의 쿼리 처리기(Query processor) 를 통해 SQL 명령문들이 접수된다.

2. 검색 또는 변경 대상이 되는 데이터 페이지 블록들이 디스크 안의 저장 데이터베이스 파일로부터 주기억장치(RAM)의 데이터베이스 버퍼 캐시 영역으로 로드된다.

3. 찾는 페이지가 이미 데이터베이스 버퍼 캐시에 있다면 다시 로드되지 않는다. 해석된 SQL 명령문들은 데이터베이스 버퍼 캐시 안의 해당 페이지를 대상으로 검색하거나 데이터 페이지 내용을 변경한다.

4. 버퍼 캐시 안의 데이터 페이지가 성공적으로 변경되면 디스크 안의 저장 데이터베이스 파일에 쓰여져야 하는데 보통은 즉시 디스크에 반영되지 않는다.

5. 지연 쓰기 전략으로 버퍼 캐시 안의 페이지들을 다시 요청하는 경우를 위해, 디스크 입출력 횟수를 최대한 줄여 성능을 향상시키기 위해서이다.

<br>

#### 로그 먼저 쓰기 규약

<br>

- 위의 과정으로 인해, 가장 최근 데이터는 대부분 버퍼 캐시 안에 남게 된다. 문제는 휘발성 저장 장치인 버퍼 캐시 내용이 디스크 기록 이전에 장애가 발생하여 삭제될 수 있다.

- 장애 발생 시 완벽한 회복이 가능해야 한다. 이를 위해 버퍼 캐시 페이지들은 즉각적으로 디스크에 반영하지 않더라도 트랜잭션 실행 기록인 로그는 매번 트랜잭션 처리 직전에 먼저 디스크 안의 로그 데이터베이스 파일에 안전하게 기록한다.

- 이를 로그 먼저 쓰기 규약 (write-ahead log protocol)이라고 한다.

<br>

#### 로그 데이터베이스

<br>

- 로그 데이터베이스 파일은 트랜잭션의 모든 데이터 변경 사항을 저장 데이터베이스 파일에 반영하기 전에 미리 기록하는 특별한 데이터베이스이다.

- 로그(log)는 데이터베이스 시스템에서 발생할 수 있는 하드웨어 또는 소프트웨어 오류나 미디어 장치 손실, 자연 재해 등의 장애로 인해 주기억 장치와 디스크 안의 데이터가 손실되는 것을 대비하여 추후 복구를 위해 저장하는 트랜잭션 처리 정보이다.

<br>

#### 백업 데이터베이스

<br>

- 백업 데이터베이스 파일은 데이터베이스 파일의 물리적 손상에 대비하여 별도로 저장한 복제 데이터베이스이다.

- 백업은 3 종류가 있다.

  - 매번 전체 데이터베이스 복사본을 저장하는 전체 백업(full backup) <br>

  - 이전 전체 데이터베이스 복사본과 차이가 있는 변경 데이터 부분만 추가로 백업하는 차등 백업(deferential back up) <br>

  - 전체 데이터베이스 복사본과 이후의 로그 데이터베이스 복사본을 저장하는 증분 백업(incremental backup)등이 있다.

- 백업 데이터베이스는 주기적으로 데이터베이스 운영에 지장을 주지 않도록 계획을 세워 생성한다. 백업 데이터베이스를 사용하여 원래 상태로 되돌리는 작업을 복원(restore)라고 한다.

- DBMS는 복원 과정과 회복을 지원하기 위해 정기적 백업과 로깅, 체크포인트 등을 수행한다. 우선 주로 야간에 일 단위, 주 단위로 지속적 백업을 통해 복사본을 생성한다. 또, 트랜잭션 실행 직전에 트랜잭션 실행 기록을 로그에 미리 저장한다.

---

### 트랜잭션 로그

<br>

- 로그를 통한 회복(recovery)의 기본 단위 역시 트랜잭션이다. 장애 발생 시 트랜잭션 단위로 회복을 진행하기 위해 트랜잭션 로그를 로그 데이터베이스 파일에 저장한다.

<br>

#### 트랜잭션 로그의 구조

<br>

- 트랜잭션 로그에는 로그 일련번호를 포함하여 트랜잭션\_식별자와 START, COMMIT, ROLLBACK, 명령문 유형과 변경 내용 등이 기록된다.

- SELECT문을 통한 데이터 검색은 데이터 값을 변경시키지 않기 때문에 로그에 기록하지 않는다.

<br>

#### 체크 포인트

<br>

- 특정 시점까지의 데이터 버퍼 안의 모든 변경 내용을 데이터베이스 파일에 물리적으로 저장하는 시점을 말한다.

- 장애 발생 시 복구 작업량을 줄이기 위해 주기적으로 동기화를 수행하고 체크 포인트 역시 로그에 기록한다.

- 체크 포인트 시점에는 버퍼 캐시 안의 데이터와 디스크 안의 저장 데이터베이스가 100% 일치하는 동기화가 수행된다.

- '검사점' 이라고도 하며 회복 대상을 마지막 체크 포인트 시점 이후의 로그 내용으로만 제한시킨다.

- 체크 포인트가 트랜 잭션 로그에 기록되는 순간 모든 데이터 버퍼 안의 데이터들이 데이터베이스 파일에 쓰여진다.

<br>

---

### 로그를 이용한 회복 기법

<br>

- 회복의 기본 개념은 장애 발생 시점에 이미 커밋된 트랜잭션의 변경 내용은 로그를 이용하여 반드시 데이터베이스에 반영한다는 것이다.

- 반면, 커밋되지 못하고 중단된 트랜잭션의 실행 결과는 철회되어야 한다.

- 트랜잭션 로그를 이용한 회복 기법의 적용 과정은 다음과 같다.

  - 회복은 장애 발생 시점에 중단된 트랜잭션의 작업 내용을 롤백, 즉 철회시키기 위해 로그 기록의 역순으로 이전 상태로 되돌리는 취소(UNDO) 작업을 진행한다.

  - 마지막 체크 포인트 이후의 커밋되지 않은 트랜잭션의 로그 내용들을 모두 롤백, 실행 순서의 역순으로 취소된다.

  - 반대로, 장애 발생 시점까지 정상적으로 종료된 트랜잭션의 실행 결과를 보장하기 위해서는 로그 기록의 순서대로 다시 실행하는 재실행(REDO) 작업이 진행된다.

  - 마지막 체크 포인트 이후의 커밋된 트랜잭션의 로그 내용들은 모두 롤 포워드(roll forward), 즉 로그 순서대로 재실행된다.

<br>

> 참조 <br> 'MySQL과 모바일 웹으로 만나는 데이터베이스의 정석'
