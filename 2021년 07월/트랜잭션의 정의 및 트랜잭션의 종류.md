## 트랜잭션(Transaction) 개념

- 한 묶음으로 처리되어야 하는 SQL 명령문들의 집합을 말한다. 트랜잭션에 속한 SQL 명령문들은 모두 정상 처리되어야 함께 완료된다. 하나의 명령문이라도 오류가 발생하면 전체 취소

- 여러가지 SQL 명령문을 트랜잭션으로 묶으려면 START TRANSACTION 명령문으로 묶을 수 있다. COMMIT 되기 전까지 트랜잭션의 실행 결과를 데이터베이스에 최종 반영할 수 없으며, 실행 결과를 반영하지 않고 취소하려면 ROLLBACK 명령어를 사용하면 된다.

```SQL
START TRANSACTION
SELECT * FROM A;
DELETE FROM A WHERE NAME='name';
SELECT * FROM B;
COMMIT;
--ROLLBACK;
```

- 트랜잭션 은 데이터베이스에서 가장 중요한 개념 중 하나이다. 데이터베이스에서 SQL 처리를 위한 작업 단위로 트랜잭션 개념을 도입한 이유는 복수 사용자의 **동시 접근성을 제어**하고 **장애 발생 시 안정적으로 데이터 복구를 하기 위해서이다.** <br>

  (데이터베이스 장애 -> 서버나 저장 장치, 네트워크의 고장, 자연 재해, 해킹)

---

## 트랜잭션 의 특성 (ACID)

1. 원자성 (Atomicity)

- 트랜잭션 안의 SQL 명령문을 모두 성공적으로 실행하거나 아니면 모두 취소해야 한다.

- 장애가 발생한다면 장애 발생 시점에 이미 정상 완료되어 커밋된 트랜잭션을 제외하고 완료되지 않은 트랜잭션은 모두 취소 시켜야 한다.

<br>

2. 일관성 (Consistency)

- 데이터베이스가 트랜잭션 실행 전의 일관된 상태에서 트랜잭션 실행 후에도 또 다른 일관된 상태로 전환되어야 함을 말한다.

- 트랜잭션 시작 전과 커밋 후에도 항상 데이터의 일관성이 유지되어야 한다.

- 동시 실행되는 트랜잭션 사이의 상호 간섭을 Lock 과 같은 방법을 통해 데이터의 일관성을 유지 시킬 수 있다.

<br>

3. 고립성 (Isolation)

- Commit이 완료될 때까지 트랜잭션이 수행한 임시 실행 결과가 다른 트랜잭션에게 영향을 주거나 받으면 안된다.

- 같은 데이터를 처리하는 다른 트랜잭션들의 간섭 방지를 위해 동시 실행중인 경우 각 트랜잭션이 Commit 되기 전까지 변경 내용을 Lock을 통해 고립시켜야 한다.

<br>

4. 지속성 (Durability)

- 트랜잭션이 Commit 되면 그 트랜잭션의 실행 결과가 장애가 발생하더라도 보존되어야 함을 말한다.

- Commit 된 트랜잭션 결과는 최종적으로 안정된 저장 장치에 반영되는 것을 보장하며 결코 손상되지 않아야 한다.

- 저장 장치가 손상되더라도 로그와 같은 실행 기록을 참조하여 손상 이전 상태로 회복 시켜야 한다.

---

## 트랜잭션 지원 DBMS 모듈

- 트랜잭션을 지원하기 위해 DBMS 는 동시성 제어와 회복 모듈을 제공한다.

  1. 동시성 제어(concurrency control) 모듈

     - 동시에 실행되는 트랜잭션의 간섭을 제어한다. 최종적으로 각 트랜잭션이 순차적으로 실행한 결과와 동일한 고립성 결과를 보장하고 트랜잭션 실행 이전과 이후의 데이터베이스 일관성이 항상 유지되게 한다.

     - 대표적인 방법으로는 Locking 이 있다.

  2. 회복 (recovery) 모듈

  - 완전한 트랜잭션 결과의 복구를 보장한다. 장애 발생 시 트랜잭션 실행의 원자성을 보장하고 커밋된 트랜잭션의 결과는 반드시 데이터베이스에 반영되도록 지속성을 지원한다.

    - 대표적인 방법으로는 Logging 이 있다.

---

## 트랜잭션의 종류

- 트랜잭션은 설정 모드에 따라 3가지로 분류할 수 있다.

  **1. 명시적 트랜잭션**

  - 트랜잭션의 시작과 긑을 사용자가 직접 명시적으로 지정하는 트랜잭션을 말한다. (사용자 트랜잭션, 수동 트랜잭션)

  ```SQL
  START TRANSACTION; -- 직접 트랜잭션의 시작을 지시, 자동 모드에서 수동 모드로 변경된다.
  ...
  SQL 명령어
  ...

  { COMMIT | ROLLBACK };
  /*
     COMMIT : 트랜잭션의 처리 결과를 확정하는 명령어, 한번 COMMIT 되면 실행 결과를 다시 되돌릴 수 없다.

     ROLLBACK : 트랜잭션 처리 내용을 취소하고 트랜잭션 시작 이전의 원래 상태로 되돌린다. 수동 모드 상태에서는 COMMIT 되기 이전까지 SQL 명령문들이 임시로 처리가 되기 때문에 트랜잭션을 이전 상태로 되돌릴 수 있다.
  */
  ```

     <br>

  **2. 자동완료 트랜잭션**

  - 특별한 설정이 없을 경우 적용되는 기본 모드의 트랜잭션(시스템 트랜잭션), 데이터베이스를 변경시키는 SQL 문 하나를 독립된 하나의 트랜잭션으로 자동 정의한다. SQL 문의 실행 결과에 따라 자동으로 커밋 또는 롤백하는 트랜잭션이다.

  - DBMS가 자동으로 START TRANSACTION 문과 COMMIT 문 또는 ROLLBACK 문을 자동으로 붙여 실행한다.

  ```SQL
  SELECT @@AUTOCOMMIT; -- @@AUTOCOMMIT 은 트랜잭션 모드 설정 값 저장 시스템 변수이다.
  SET AUTOCOMMIT=1; -- 1이면 TRUE로 자동 설정완료 된 것이다.
  ```

  ```SQL
  INSERT INTO NAME VALUES (...)
  SELECT * FROM NAME ;   --자동완료모드에서는 INSERT SELECT 각각 START TRANSACTION과 COMMIT 명령문이 자동으로 추가된다.
  ROLLBACK; -- 위 SQL 명령어가 각각 트랜잭션으로 커밋됐으므로 더 이상 실행중인 트랜잭션이 없어 롤백할 대상이 없다.
  SELECT * FROM NAME;
  ```

  <br>

  **3. 수동완료 트랜잭션**

  - 트랜잭션의 끝만 사용자가 직접 명시적으로 지정하는 트랜잭션

  - 트랜잭션의 시작은 자동으로 실행된다. 묵시적(implicit) 트랜잭션이라고도 한다.

  - 보통 데이터를 추가, 수정, 삭제 조회하는 조작 명령어인 DML 문장이 실행됨과 동시에 트랜잭션이 시작된다.

  ```SQL
  SELECT @@AUTOCOMMIT; -- 자동 커밋 현재 설정 상태 확인
  SET AUTOCOMMIT = 0; -- 수동완료 모드 설정 (자동완료 모드 해제)
  ```

  ```SQL
  DELETE FROM MOVIE WHERE M_NAME ...  -- 새로운 수동완료 트랜잭션 시작
  SELECT * FROM MOVIE; -- 삭제 후 임시 삭제 결과, COMMIT되지 않았으므로 언제든지 취소가능, 실행결과를 확정하려면 반드시 COMMIT
  INSERT INTO MOVIE VALUES (...);
  SELECT * FROM MOVIE;
  ROLLBACK; -- 트랜잭션을 커밋하지 않고 롤백, 위의 DELETE, INSET 명령문 결과는 모두 취소
  SELECT * FROM MOVIE;
  SET AUTOCOMMIT=1; -- 자동완료 모드로 재설정
  ```

---
