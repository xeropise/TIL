## MySQL 로그 파일

- MySQL 서버에서 서버의 상태를 진단할 수 있는 많은 도구가 지원되지만 이러한 기능들은 많은 지식을 필요로 하는 경우가 많다.

  

- 로그 파일을 이용하면 MySQL 서버의 깊은 내부 지식이 없어도 MySQL의 상태나 부하를 일으키는 원인을 쉽게 찾아서 해결할 수 있다.

  - 많은 사용자가 로그 파일의 내용을 무시하고 다른 방법으로 해결책을 찾으려고 노력하고는 하는데, 무엇보다 MySQL 서버에 문제가 생겼을 때는 다음에 설명하는 로그 파일들을 자세히 확인하는 습관을 들일 필요가 있다.

    

<br>

***

### 에러 로그 파일

- MySQL 이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일이다.

  

- 에러 로그 파일의 위치는  MySQL 설정 파일(my.cnf)에서 log_error 라는 이름의 파라미터로 정의된 경로에 생성된다.

  - MySQL 설정 파일에 별도로 정의되지 않은 경우에는 데이터 디렉터리(datadir 파라미터에 설정된 디렉터리)에 .err라는 확장자가 붙은 파일로 생성된다.

    

- 여러 가지 메시지가 다양하게 출력되지만, 다음에 소개되는 메시지들을 가장 자주 보게 된다.

  1. __MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지__

     - MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후, 다시 시작하는 경우에는 반드시 MySQL 에러 로그 파일을 통해 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용되었는지 확인해야 한다.

       

     - MySQL 서버가 정상적으로 기동했고('mysqld: ready for connections'), 새로 변경하거나 추가한 파라미터에 대한 특별한 에러나 경고성 메시지가 없다면 정상적으로 적용된 것으로 판단하면 된다.

       - 그렇지 않고, 특정 변수가 무시된 경우에는 MySQL 서버는 정상적으로 기동하지만, 해당 파라미터는 MySQL에 적용되지 못했음을 의미한다.
         - 변수명을 인식하지 못하거나, 설정된 파라미터 값의 내용을 인식하지 못하는 경우에는 MySQL 서버가 에러 메시지를 출력하고, 시작하지 못했다는 메시지를 보여줄 것이다.

     

  2. __마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지__

     - InnoDB의 경우에는 MySQL 서버가 비정상적 또는 강제적으로 종료되었다면, 다시 시작되면서 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리 작업을 하게 된다.

       - 이 과정에 대한 간단한 메시지가 출력되는데, 간혹 문제가 있어서 복구되지 못할 때는 해당 에러 메시지를 출력하고 MySQL은 다시 종료될 것이다.

         

     - 일반적으로 이 단계에서 발생하는 문제는 상대적으로 해결하기가 어려운 문제점일 때가 많고, 때로는 innodb_force_recovery 파라미터를 0보다 큰 값으로 설정하고 재시작해야만 MySQL이 시작될 수도 있다.

     

  3. __쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지__

     - 쿼리 도중 발생하는 문제점은 사전 예방이 어려우며, 주기적으로 에러 로그 파일을 검토하는 과정에서 알게 된다.

       

     - 쿼리의 실행 도중 발생한 에러나 복제에서 문제가 될 만한 쿼리에 대한 경고 메시지가 에러 로그에 기록된다.

       

     - 자주 에러 로그 파일을 검토하는 것이 데이터베이스의 숨겨진 문제점을 해결하는 데 많이 도움이 될 것이다.

     

  4. __비정상적으로 종료된 커넥션 메시지(Aborted connection)__

     - 어떤 데이터베이스 서버의 로그 파일을 보면 이 메시지가 상당히 많이 누적되어 있는 경우가 있다.

       

     - 클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고, 프로그램이 종료된 경우, MySQL 서버의 에러 로그 파일에 이런 내용이 기록된다.

       

     - 물론 중간에 네트워크에 문제가 있어서 의도하지 않게 접속이 끊어지는 경우에도 이런 메시지가 기록 된다. 이런 메시지가 많이 기록된다면 애플리케이션의 커넥션 종료 로직을 한번 검토해볼 필요가 있다.

       - [max_connect_errors 시스템 변수](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_connect_errors) 값이 너무 낮게 설정된 경우, 클라이언트 프로그램이 MySQL 서버에 접속하지 못하고, "Host 'host_name' is blocked" 라는 에러가 발생할 수도 있다.

         - 이 메시지는 클라이언트 호스트에서 발생한 에러 (커넥션 실패나 강제 연결 종료와 같은)의 횟수가 max_connect_erros 변수의 값을 넘게 되면 발생하는데, 이 경우 max_connect_erros 시스템 변수의 값을 증가시키면 된다. 

           

         - 하지만, 먼저 이 에러가 어떻게 발생하게 됐는지 그 원인을 살펴보는 것이 좋다.

           

  5. __InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS 같은)의 결과 메시지__

     - InnoDB의 테이블 모니터링이나 락 모니터링, 또는 InnoDB의 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록한다.

       

     - InnoDB의 모니터링을 활성화 상태로 만들어 두고 그대로 유지하는 경우에는 에러 로그 파일이 매우 커져서 파일 시스템의 공간을 다 사용해 버릴지도 모른다.

       

     - 모니터링을 사용한 이후에는 다시 비활성화해서 에러 로그 파일이 커지지 않게 만들어야 한다.

       

  6. __MySQL의 종료 메시지__

     - 가끔 MySQL이 아무도 모르게 종료되어 있거나 때로는 아무도 모르게 재시작되는 경우를 본 적이 있을 것이다.

       - __이러한 경우, 에러 로그 파일에서 MySQL이 마지막으로 종료되면서 출력한 메시지를 확인하는 것이 왜 MySQL 서버가 종료되었는지 확인하는 유일한 방법이다.__

         

       - 만약 누군가가 MySQL 서버를 종료시켰다면 에러 로그 파일에서 'Received SHUTDOWN from user ...' 이라는 메시지를 확인할 수 있을 것이다.

         - 그렇지 않고, 아무런 종료 관련 메시지가 없거나 스택 트레이스 (16진수 주소값이 출력)와 같은 내용이 출력되는 경우에는 MySQL 서버가 세그먼테이션 폴트(Segmentation fault)로 비정상적으로 종료된 것으로 판단할 수 있다.

           

         - 세그먼테잉션 폴트로 종료된 경우에는 스택 트레이스의 내용을 최대한 참조해서 MySQL의 버그와 연관이 있는지 조사한 후, MySQL의 버전을 업그레이드하거나 회피책(WorkAround)을 찾는 것이 최적의 방법이다. 