## MySQL 로그 파일

- MySQL 서버에서 서버의 상태를 진단할 수 있는 많은 도구가 지원되지만 이러한 기능들은 많은 지식을 필요로 하는 경우가 많다.

  

- 로그 파일을 이용하면 MySQL 서버의 깊은 내부 지식이 없어도 MySQL의 상태나 부하를 일으키는 원인을 쉽게 찾아서 해결할 수 있다.

  - 많은 사용자가 로그 파일의 내용을 무시하고 다른 방법으로 해결책을 찾으려고 노력하고는 하는데, 무엇보다 MySQL 서버에 문제가 생겼을 때는 다음에 설명하는 로그 파일들을 자세히 확인하는 습관을 들일 필요가 있다.

    

<br>

***

### 에러 로그 파일

- MySQL 이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일이다.

  

- 에러 로그 파일의 위치는  MySQL 설정 파일(my.cnf)에서 log_error 라는 이름의 파라미터로 정의된 경로에 생성된다.

  - MySQL 설정 파일에 별도로 정의되지 않은 경우에는 데이터 디렉터리(datadir 파라미터에 설정된 디렉터리)에 .err라는 확장자가 붙은 파일로 생성된다.

    

- 여러 가지 메시지가 다양하게 출력되지만, 다음에 소개되는 메시지들을 가장 자주 보게 된다.

  1. __MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지__

     - MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후, 다시 시작하는 경우에는 반드시 MySQL 에러 로그 파일을 통해 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용되었는지 확인해야 한다.

       

     - MySQL 서버가 정상적으로 기동했고('mysqld: ready for connections'), 새로 변경하거나 추가한 파라미터에 대한 특별한 에러나 경고성 메시지가 없다면 정상적으로 적용된 것으로 판단하면 된다.

       - 그렇지 않고, 특정 변수가 무시된 경우에는 MySQL 서버는 정상적으로 기동하지만, 해당 파라미터는 MySQL에 적용되지 못했음을 의미한다.
         - 변수명을 인식하지 못하거나, 설정된 파라미터 값의 내용을 인식하지 못하는 경우에는 MySQL 서버가 에러 메시지를 출력하고, 시작하지 못했다는 메시지를 보여줄 것이다.

     

  2. __마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지__

     - InnoDB의 경우에는 MySQL 서버가 비정상적 또는 강제적으로 종료되었다면, 다시 시작되면서 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리 작업을 하게 된다.

       - 이 과정에 대한 간단한 메시지가 출력되는데, 간혹 문제가 있어서 복구되지 못할 때는 해당 에러 메시지를 출력하고 MySQL은 다시 종료될 것이다.

         

     - 일반적으로 이 단계에서 발생하는 문제는 상대적으로 해결하기가 어려운 문제점일 때가 많고, 때로는 innodb_force_recovery 파라미터를 0보다 큰 값으로 설정하고 재시작해야만 MySQL이 시작될 수도 있다.

     

  3. __쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지__

     - 쿼리 도중 발생하는 문제점은 사전 예방이 어려우며, 주기적으로 에러 로그 파일을 검토하는 과정에서 알게 된다.

       

     - 쿼리의 실행 도중 발생한 에러나 복제에서 문제가 될 만한 쿼리에 대한 경고 메시지가 에러 로그에 기록된다.

       

     - 자주 에러 로그 파일을 검토하는 것이 데이터베이스의 숨겨진 문제점을 해결하는 데 많이 도움이 될 것이다.

     

  4. __비정상적으로 종료된 커넥션 메시지(Aborted connection)__

     - 어떤 데이터베이스 서버의 로그 파일을 보면 이 메시지가 상당히 많이 누적되어 있는 경우가 있다.

       

     - 클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고, 프로그램이 종료된 경우, MySQL 서버의 에러 로그 파일에 이런 내용이 기록된다.

       

     - 물론 중간에 네트워크에 문제가 있어서 의도하지 않게 접속이 끊어지는 경우에도 이런 메시지가 기록 된다. 이런 메시지가 많이 기록된다면 애플리케이션의 커넥션 종료 로직을 한번 검토해볼 필요가 있다.

       - [max_connect_errors 시스템 변수](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_connect_errors) 값이 너무 낮게 설정된 경우, 클라이언트 프로그램이 MySQL 서버에 접속하지 못하고, "Host 'host_name' is blocked" 라는 에러가 발생할 수도 있다.

         - 이 메시지는 클라이언트 호스트에서 발생한 에러 (커넥션 실패나 강제 연결 종료와 같은)의 횟수가 max_connect_erros 변수의 값을 넘게 되면 발생하는데, 이 경우 max_connect_erros 시스템 변수의 값을 증가시키면 된다. 

           

         - 하지만, 먼저 이 에러가 어떻게 발생하게 됐는지 그 원인을 살펴보는 것이 좋다.

           

  5. __InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS 같은)의 결과 메시지__

     - InnoDB의 테이블 모니터링이나 락 모니터링, 또는 InnoDB의 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록한다.

       

     - InnoDB의 모니터링을 활성화 상태로 만들어 두고 그대로 유지하는 경우에는 에러 로그 파일이 매우 커져서 파일 시스템의 공간을 다 사용해 버릴지도 모른다.

       

     - 모니터링을 사용한 이후에는 다시 비활성화해서 에러 로그 파일이 커지지 않게 만들어야 한다.

       

  6. __MySQL의 종료 메시지__

     - 가끔 MySQL이 아무도 모르게 종료되어 있거나 때로는 아무도 모르게 재시작되는 경우를 본 적이 있을 것이다.

       - __이러한 경우, 에러 로그 파일에서 MySQL이 마지막으로 종료되면서 출력한 메시지를 확인하는 것이 왜 MySQL 서버가 종료되었는지 확인하는 유일한 방법이다.__

         

       - 만약 누군가가 MySQL 서버를 종료시켰다면 에러 로그 파일에서 'Received SHUTDOWN from user ...' 이라는 메시지를 확인할 수 있을 것이다.

         - 그렇지 않고, 아무런 종료 관련 메시지가 없거나 스택 트레이스 (16진수 주소값이 출력)와 같은 내용이 출력되는 경우에는 MySQL 서버가 세그먼테이션 폴트(Segmentation fault)로 비정상적으로 종료된 것으로 판단할 수 있다.

           

         - 세그먼테잉션 폴트로 종료된 경우에는 스택 트레이스의 내용을 최대한 참조해서 MySQL의 버그와 연관이 있는지 조사한 후, MySQL의 버전을 업그레이드하거나 회피책(WorkAround)을 찾는 것이 최적의 방법이다. 



<br>

***

### 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)

- 가끔 MySQL 서버에서 실행되는 쿼리로 어떤 것들이 있는지 전체 목록을 뽑아서 검토해 볼 때가 있는데, 이때는 쿼리 로그를 활성화해서 쿼리를 쿼리 로그 파일로 기록하게 한 다음, 그 파일을 검토하면 된다.

  

- 쿼리 로그 파일에는 다음과 같이 시간 단위로 실행되었떤 쿼리의 내용이 모두 기록되는데, 슬로우 쿼리로그와는 조금 다르게 제너럴 쿼리 로그는 실행되기 전에 MySqL이 쿼리 요청을 받으면 바로 기록하기 때문에 쿼리 실행 중에 에러가 발생해도 일단 로그 파일에 기록된다.

  

- 쿼리 로그 파일의 경로는 general_log_file 이라는 이름의 파라미터에 설정되어 있다. 쿼리 로그를 파일이 아닌 테이블에 저장하도록 설정할 수 있으므로, 이 경우에는 파일이 아닌 테이블을 SQL로 조회해서 검토해야 한다.

```mysql
> show variables like 'general_log_file';

Variable_name     || Value
general_log_file  || /rdsdbdata/log/general/mysql-general.log

```



- 쿼리 로그를 파일로 저장할지 테이블로 저장할지는 [log_output 파라미터](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_log_output) 로 결정된다. 

  - 제너럴 로그와 관련된 상세한 내용은 MySQL 메뉴얼의 'log_output 설정 파라미터' 와 ['The General Query Log'](https://dev.mysql.com/doc/refman/5.7/en/query-log.html) 절을 참조하자.

    

  - 로그 파일의 경로에 관련된 상세한 내용은 ['Selecting General Query and SlowQuery Log Output Destinations'](https://dev.mysql.com/doc/refman/5.7/en/log-destinations.html) 를 참조하자.



<br>

***

### 슬로우 쿼리 로그

- MySQL 서버의 쿼리 튜닝은 크게 서비스가 적용되기 전에 전체적으로 튜닝하는 경우와 서비스 운영 중에 MySQL 서버의 전체적인 성능 저하를 검사하거나 정기적인 점검을 위한 튜닝으로 나눌 수 있다.

  - 전자의 경우에는 검토해야 할 대상 쿼리가 전부라서 모두 튜닝하면 되지만, 후자의 경우에는 어떤 쿼리가 문제의 쿼리인지 판단하기가 상당히 어렵다.

    

  - 이런 경우, 서비스에서 사용되는 쿼리 중에서 어떤 쿼리가 문제인지를 판단하는 데 슬로우 쿼리 로그가 상당히 많은 도움이 된다.

    

- 슬로우 쿼리 로그 파일에는 [long_query_time 시스템 변수](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_long_query_time) 에 설정한 시간(초단위로 설정하지만, 소수점 값으로 설정하면 마이크로 초 단위로 설정 가능함) 이상의 시간이 소요된 쿼리가 모두 기록된다.

  

- 슬로우 쿼리로그는 MySQL이 쿼리를 실행한 후, 실제 소요된 시간을 기준으로 슬로우 쿼리 로그에 기록할지 여부를 판단하기 때문에 반드시 쿼리가 정상적으로 실행이 왼료되어야 슬로우 쿼리 로그에 기록될 수 있다.

  - __슬로우 쿼리 로그 파일에 기록되는 쿼리는 일단 정상적으로 실행이 완료되었고, 실행하는 데 걸린 시간이 long_query_time에 정의된 시간보다 많이 걸린 쿼리인 것이다.__

  

- log_output 옵션을 이용해 슬로우 쿼리 로그를 파일로 기록할지 테이블로 기록할지 선택할 수 있다.

  - TABLE로 설정하면 로그를 (slow_log 테이블)에 저장

    - log_output 옵션을 TABLE로 설정하더라도 mysql DB의 slow_log 테이블과 general_log 테이블은 CSV 스토리지 엔진을 사용하기 때문에 결국 CSV 파일로 저장하는 것과 동일하게 작동한다.

  - FILE로 설정하면 로그의 내용을 디스크의 파일로 저장한다.

    

- 쿼리 로그 내용을 보는법이나 분석 방법은 메뉴얼 혹은 책을 참조하도록 하자.