## 클러스터링 테이블 사용 시 주의사항

- MyISAM과 같이 클러스터링되지 않은 테이블에 비해 __InnoDB 테이블(클러스터링 테이블)에서는 조금 더 주의할 사항이 있다__



<br>

***

### 클러스터링 인덱스 키의 크기

- 클러스터링 테이블의 경우, 모든 세컨더리 인덱스가 PK 값을 포함한다. 그래서 PK가 커지면 세컨더리 인덱스도 자동으로 크기가 커진다.

  

- 일반적으로 테이블에 세컨더리 인덱스가 4~5개 정도 생성된다는 것을 고려하면 세컨더리 인덱스 크기는 급격히 증가한다.

  

- 5개의 세컨더리 인덱스를 가지는 테이블의 PK가 10바이트인 경우와 50바이트인 경우를 비교해 보자.

  

| PK 크기   | 레코드 당 증가하는 인덱스 크기 | 100만 건 레코드 저장 시, 증가하는 인덱스 크기 |
| --------- | ------------------------------ | --------------------------------------------- |
| 10 바이트 | 10 바이트 * 5 = 50바이트       | 50바이트 * 1,000,000 = 47MB                   |
| 50 바이트 | 50바이트 * 5 = 250바이트       | 250바이트 * 1,000,000 = 238MB                 |



- 레코드 한 건, 한 건을 생각하면 50바이트쯤이야 대수로빚 않지만 레코드 건수가 100만 건만 되어도 인덱스의 크기가 거의 190MB나 증가했다.

  - 1000만 건이 되면 1.9GB가 증가한다!!

    

- 인덱스가 커질수록 같은 성능을 내기 위해 그만큼의 메모리가 더 필요해지므로 InnoDB 테이블의 PK는 신중하게 선택해야 한다.



<br>

***

### PK는 AUTO-INCREMENT 보다는 업무적인 컬럼으로 생성 (가능한 경우)

- 다시 한번 강조하지만, InnoDB PK는 클러스터링 키로 사용되며, 이 값에 의해 레코드의 위치가 결정된다.

  

- 즉, PK로 검색하는 경우 (특히 범위로 많은 레코드를 검색하는 경우) 클러스터링되지 않은 테이블에 비해 매우 빠르게 처리될 수 있음을 의미한다.

  

- MyISAM과 같이 클러스터링되지 않는 테이블에서는 사실 PK로 뭘 선택해도 성능의 차이는 별로 없을 수 있지만, InnoDB에서는 엄청난 차이를 만들어 낸다.

  

- PK는 그 의미만큼이나 중요한 역할을 하기 때문에 대부분 검색에서 상당히 빈번하게 사용되는 것이 일반적이다.

  

- 설령 그 컬럼의 크기가 크더라도 업무적으로 해당 레코드를 대표할 수 있다면, 그 컬럼을 프라이머리 키로 설정하는 것이 좋다.



<br>

***

### PK는 반드시 명시할 것

- 가끔 PK가 없는 테이블을 자주 보게 되는데, 가능하면 AUTO_INCREMENT 컬럼을 이용해서라도 PK는 생성하는 것을 권장한다.

  

- 앞서 말했듯, 정의하지 않으면 InnoDB 스토리지 엔진이 내부적으로 일련번호 컬럼을 추가하고, 자동 추가된 컬럼은 사용자에게 보이지 않기 때문에 사용자가 전혀 접근(사용)할 수가 없다.

  

- 즉, InnoDB 테이블에 PK를 정의하지 않는 경우와 AUTO_INCREMENT 컬럼을 생성하고, PK로 설정하는 것이 결국 똑같다는 것이다.

  - 사용자가 사용할 수 있는 값을 PK로 설정하는 것이 좋을 것이다.

    

- ROW 기반의 복제나 InnoDB Cluster 에서는 모든 테이블이 PK를 가져야만 하는 정상적인 복제 성능을 보장하기도 하므로 PK는 꼭 생성하자.



<br>

***

### AUTO-INCREMENT 컬럼을 인조 식별자로 사용할 경우

- 여러 개의 컬럼이 복합으로 PK가 만들어지는 경우, PK의 크기가 길어질 때가 가끔 있다.

  

- PK의 크기가 길어도 세컨더리 인덱스가 필요치 않다면 그대로 PK를 사용하는 것이 좋다.

  

- 세컨더리 인덱스도 필요하고, PK의 크기도 길다면 AUTO_INCREMENT 컬럼을 추가하고, 이를 PK로 설정하면 된다.

  

- 이렇게 PK를 대체하기 위해 인위적으로 추가된 PK를 인조 식별자(Surrogate key) 라고 한다.

  

- 로그 테이블과 같이 조회보다는 INSERT 위주의 테이블들은 AUTO_INCREMENT 를 이용한 인조 식별자를 PK로 설정하는 것이 성능 향상에 도움이 된다.