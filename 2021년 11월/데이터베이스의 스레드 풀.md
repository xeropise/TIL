### MySQL의 스레드 풀

- MySQL 엔터프라이즈 에디션은 스레드 풀(Thread Pool) 기능을 제공하지만, MySQL 커뮤니티 에디션은 스레드 풀 기능을 지원하지 않는다.

  - 책에서는 Percona Server에서 제공하는 스레드 풀 기능을 살펴보고 있긴하나 자세하게 서술하지는 않겠다.

    

- 스레드 풀은 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여서 동시 처리되는 요청이 많다 하더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것이 목적이다.

  - 스레드 풀만 설치하면 성능이 그냥 두배쯤 올라갈 것이라 생각하는데, 실제 서비스에서 눈에 띄는 성능 향상을 보여준 경우는 드물다.

    

- 스레드 풀은 앞에서 말했듯 동시에 실행 중인 스레드들을 CPU가 최대한 잘 처리해낼 수 있는 수준으로 줄여서 빨리 처리하게 하는 기능이기 때문에 스케쥴링 과정에서 CPU 시간을 제대로 확보하지 못하는 경우에는 쿼리 처리가 더 느려지는 사례도 발생할 수 있다.

  - 물론 제한된 수의 스레드만으로 CPU가 처리하도록 적절히 유도한다면 [CPU의 프로세서 친화도(Processor affinity)](https://blog.naver.com/aquayo/80061322453)도 높이고, 운영체제 입장에서는 불필요한 컨텍스트 스위치(Context switch)를 줄여서 오버헤드를 낮출 수 있다.

    

- 스레드 그룹의 개수는 thread_pool_size 시스템 변수를 변경해서 조정가능하며, CPU의 코어의 개수와 맞추는 것이 CPU 프로세서 친화도를 높이는 데 좋다.

  

- MySQL 서버가 처리해야 할 요청이 생기면 스레드 풀로 처리를 이관하는데, 만약 이미 스레드 풀이 처리 중인 작업이 있는 경우에는 thread_pool_oversubscribe 시스템 변수에 설정된 개수만큼 추가로 더 받아들여서 처리한다.

  - 이 값이 너무 크면 스케쥴링 해야 할 스레드가 많아져서 스레드 풀이 비효율적으로 작동할 수도 있다.

    

- 스레드 그룹의 모든 스레드가 일을 처리하고 있다면 스레드 풀은 해당 스레드 그룹에 새로운 작업 스레드(Worker thread)를 추가할지, 아니면 기존 작업 스레드가 처리를 완료 할 때까지 기다릴지 여부를 판단해야 한다.

  - 스레드 풀의 타이머 스레드는 주기적으로 스레드 그룹의 상태를 체크해서 thread_pool_stall_limit 시스템 변수에 정의된 밀리초만큼 작업 스레드가 지금 처리 중인 작업을 끝내지 못하면 새로운 스레드를 생성해서 스레드 그룹에 추가한다.

    - 이때, 전체 스레드 풀에 있는 스레드의 개수는 thread_pool_max_threads 시스템 변수에 설정된 개수를 넘어설 수 없다.

      

  - 모든 스레드 그룹의 스레드가 각자 작업을 처리하고 있는 상태에서 새로운 쿼리 요청이 들어오더라도 스레드 풀은 thread_pool_stall_limit 시간 동안 기다려야만 새로 들어온 요청을 처리할 수 있다는 뜻이다.

    - 응답 시간에 매우 민감한 서비스라면 thread_pool_stall_limit 시스템 변수를 적절히 낮춰서 설정해야 한다.

      

    - 그렇다고 0에 가까운 값으로 설정하는 것은 권장하지 않는다. 0으로 설정해야 한다면 스레드 풀을 사용하지 않는 편이 더 낫다.