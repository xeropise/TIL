## InnoDB 스토리지 엔진 아키텍처

![제목 없음](https://user-images.githubusercontent.com/50399804/146808621-374e7be5-40db-413b-8e38-3cd46e0841d1.png)



- InnoDB는 MySQL에서 사용할 수 있는 스토리지 엔진 중 거의 유일하게 레코드 기반의 잠금을 제공하며, 그 때문에 높은 동시성 처리가 가능하고 안정적이며 성능이 뛰어나다.

  

- InnoDB 스토리지 엔진의 주요 특징들을 살펴 보자.

  

<br>

***

### PK에 의한 클러스터링

- InnoDB의 모든 테이블은 기본적으로 PK를 기준으로 클러스터링되어 저장된다.

  - PK 값의 순서대로 디스크에 저장된다는 뜻이며, 모든 세컨더리 인덱스는 레코드의 주소 대신 PK의 값을 논리적인 주소로 사용한다.

    

- PK가 클러스터링 인덱스이므로 PK를 이용한 레인지 스캔은 상당히 빨리 처리될 수 있다.

  

- 쿼리의 실행 계획에서 PK는 기본적으로 다른 보조 인덱스에 비해 비중이 높게 설정 (다른 인덱스보다 선택될 확률이 높음)이 된다.

  

- MyISAM 스토리지 엔진에서는 클러스터링 키를 지원하지 않아, 구조적으로 PK와 세컨더리 인덱스의 차이가 없다.

  - MyISAM에서는 PK는 유니크 제약을 가진 세컨더리 인덱스일 뿐이다.

    

  - MyISAM 테이블의 PK및 모든 인데스는 물리적인 레코드 주소 값(ROWID)을 가진다.



<br>

***

### 외래 키 지원

- 외래 키에 대한 지원은 MyISAM이나 MEMORY 테이블에서는 사용할 수 없다.

  

- 외래 키는 데이터베이스 서버 운영의 불편함 때문에 서비스용 데이터베이스에서는 생성하지 않는 경우도 자주 있는데, 그렇다 하더라도 개발 환경의 데이터베이스에서는 좋은 가이드 역할을 할 수 있다.

  

- InnoDB 에서 외래키는 부모 테이블과 자식테이블 모두 해당 컬럼에 인덱스 생성이 필요하고, 변경 시에는 반드시 부모 테이블이나 자식 테이블에 데이터가 있는지 체크하는 작업이 필요하므로 자금이 여러 테이블로 전파되고, 그로 인해 데드락이 발생할 때가 많으로 개발할 때도 외래 키의 존재에 주의하는 것이 좋다.

  

- 수동으로 데이터를 적재하거나 스키마 변경 등의 관리 작업이 실패할 수도 있다. 물론 부모 테이블과 자식 테이블의 관계를 명확히 파악해서 순서대로 작업한다면 문제 없이 실행할 수 있지만, 외래 키가 복잡하게 얽힌 경우에는 그렇게 간단하지 않다.

  - 서비스에 문제가 있어 긴급하게 뭔가 조치를 해야하는데 이런 문제가 발생하면 더 조급해질 수도 있다.

    - __이런 경우, foreign_key_checks 시스템 변수를 OFF로 설정하면 외래 키 관계에 대한 체크 작업을 일시적으로 멈출 수 있다.__

      - 대략 레코드 적재나 삭제 등의 작업도 부가적인 체크가 필요 없기 때문에 훨씬 빠르게 처리할 수 있다.

      ```mysql
      > SET foreign_key_checks=OFF;
      ```

    

  - 외래 키 체크를 일시적으로 해제했다고 해서 부모와 자식 테이블 간의 관계가 깨진 상태로 그대로 유지해도 된다는 것을 의미하지는 않는다.

    - __외래키 체크를 일시적으로 중지한 상태에서 외래 키 관계를 가진 부모 테이블의 레코드를 삭제했다면, 반드시 자식 테이블의 레코드도 삭제해서 일관성을 맞춰준 후 다시 외래 키 체크 기능을 활성화해야 한다.__

      

    - foreign_key_checks가 비활성화되면 외래키 관계의 부모 테이블에 대한 작업(ON DELETE CASCADE와 ON UPDATE CASCADE 옵션)도 무시하게 된다.

      

  - foreign_key_checks 시스템 변수는 적용 범위를 GLOBAL과  SESSION  모두로 설정 가능한 변수다.

    - 이런 작업을 할 떄는 현재 작업을 실행하는 세션에서만 외래 키 체크 기능을 멈추게 해야 한다.

      

    - SESSION  키워드를 명시하지 않으면 자동으로 현재 세션의 설정만 변경하기 때문에 다음 두 명령은 동일한 효과를 낸다. 

    ```mysql
    > SET foreign_key_checks=OFF;
    > SET SESSION foreign_key_checks=OFF;
    ```



<br>

***

### MVCC(Multi Version Concurrency Control)

- 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능

  

- 잠금을 사용하지 않는 일관된 읽기를 제공하는데에 가장 큰 목적이 있다.

  

- InnoDB는 언두 로그(Undo log)를 이용해 이 기능을 구현하는데 멀티 버전이라 함은 하나의 레코드에 대해 여러 개의 버전이 동시에 관리된다는 의미이다.



- 작성 중 